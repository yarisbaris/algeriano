<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Algeriano_Neo â€” Hybrid Feed</title>
<style>
:root{
  --bg:#05060a; --panel:#0b0f19; --muted:#9aa3b2;
  --primary:#00c2ff; --accent:#8b00ff; --glass: rgba(255,255,255,0.03);
  --text:#e8f6ff;
  font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#020207);color:var(--text);-webkit-font-smoothing:antialiased}
.header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-bottom:1px solid rgba(255,255,255,0.03);position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg, rgba(0,0,0,0.35), rgba(0,0,0,0.15));z-index:120}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#020202;font-weight:900;font-size:16px}
.title{font-weight:900;font-size:18px}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:var(--primary);cursor:pointer;font-weight:800}
.btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#000;border:none}
.btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.03)}
.input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
.small{font-size:13px;color:var(--muted);}

/* layout */
.app-wrap{position:fixed;top:64px;bottom:0;left:0;right:0;display:flex;overflow:hidden}
.sidebar{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-left:1px solid rgba(255,255,255,0.02);padding:12px;display:flex;flex-direction:column;gap:12px}
.main{flex:1;position:relative;overflow:hidden}
.footer-note{position:fixed;left:0;right:0;bottom:0;padding:8px;text-align:center;color:var(--muted);font-size:12px;z-index:50}

/* Hybrid feed styles */
.view-toolbar{display:flex;gap:8px;align-items:center;padding:8px}
.toggle{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer}
.feed-full{position:absolute;inset:0;overflow-y:scroll;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch}
.feed-card{position:relative;height:100vh;scroll-snap-align:start;display:flex;align-items:center;justify-content:center;background:#000;overflow:hidden}
.feed-video{width:100%;height:100%;object-fit:cover;background:#000}
.meta{position:absolute;left:16px;bottom:26px;right:86px;display:flex;flex-direction:column;gap:6px;text-align:right;z-index:40}
.meta .user{font-weight:900;font-size:16px}
.meta .title{font-size:14px;color:var(--muted)}
.side-controls{position:absolute;right:12px;bottom:100px;display:flex;flex-direction:column;gap:12px;align-items:center;z-index:50}
.icon{width:56px;height:56;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:900}
.icon .count{display:block;font-size:12px;color:var(--muted);margin-top:6px;text-align:center}

/* grid view */
.feed-grid{position:absolute;inset:0;overflow:auto;padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.grid-item{background:#071018;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.grid-thumb{width:100%;height:160px;object-fit:cover;background:#000}
.grid-title{padding:8px;font-weight:800;color:var(--text);font-size:14px}
.grid-user{padding:0 8px 8px;color:var(--muted);font-size:12px}

/* upload & widgets */
.widget{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.upl-input{display:flex;flex-direction:column;gap:8px}
.profile-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:200}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);max-width:720px;width:100%}

/* responsive */
@media(max-width:1000px){
  .sidebar{display:none}
  .app-wrap{top:64px}
  .grid-thumb{height:120px}
}
</style>
</head>
<body>

<header class="header" title="Double-click to open Admin">
  <div class="brand">
    <div class="logo">AN</div>
    <div>
      <div class="title">Algeriano_Neo</div>
      <div class="small">Hybrid Feed â€” Full / Grid</div>
    </div>
  </div>
  <div class="controls">
    <input id="search" class="input" placeholder="Ø¯ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ÙŠÙˆØ²Ø±" style="width:220px">
    <button class="btn" id="btnRandom">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
    <button class="btn primary" id="btnUpload">Ø±ÙØ¹</button>
    <button class="btn" id="btnPay">Ø¯ÙØ¹</button>
    <button class="btn" id="btnProfile">Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ</button>
    <button class="btn" id="btnToggleView" title="Ø¨Ø¯Ù„ Ø§Ù„Ø¹Ø±Ø¶">Full / Grid</button>
  </div>
</header>

<div class="app-wrap">
  <div class="main">
    <!-- Full-screen feed -->
    <div id="feedFull" class="feed-full" role="feed" aria-live="polite"></div>

    <!-- Grid feed (hidden by default) -->
    <div id="feedGrid" class="feed-grid" style="display:none"></div>
  </div>

  <!-- Sidebar widgets (desktop) -->
  <aside class="sidebar">
    <div class="widget">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø®ØªØµØ±Ø©</strong><button class="btn ghost" id="btnAdminMini">Admin</button>
      </div>
      <div class="small" style="margin-top:8px">BaridiMob: <span id="baridiDisplay">(ÙØ§Ø±Øº)</span></div>
    </div>

    <div class="widget">
      <strong>Ø±ÙØ¹ Ø³Ø±ÙŠØ¹</strong>
      <div class="upl-input" style="margin-top:8px">
        <input id="sideFile" type="file" accept="video/*">
        <input id="sideUrl" class="input" placeholder="Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· mp4">
        <input id="sideTitle" class="input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
        <div style="display:flex;gap:8px"><button class="btn primary" id="sideUploadBtn">Ø±ÙØ¹</button><button class="btn ghost" id="sideClear">Ù…Ø³Ø­</button></div>
      </div>
    </div>

    <div class="widget">
      <strong>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</strong>
      <div class="small" style="margin-top:8px" id="statVideos">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª: 0</div>
      <div class="small" id="statUsers">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: 0</div>
      <div class="small" id="statPayments">Ø·Ù„Ø¨Ø§Øª Ø¯ÙØ¹: 0</div>
    </div>

    <div class="widget">
      <strong>Ù…ÙØ¶Ù„Ø§ØªÙŠ</strong>
      <div class="profile-grid" id="favGrid"></div>
    </div>
  </aside>
</div>

<div class="footer-note">Algeriano_Neo â€” Hybrid â€¢ Dark Neon</div>

<!-- Overlay -->
<div id="overlay" class="overlay" aria-hidden="true"><div class="card" id="overlayCard"></div></div>

<script>
/* -----------------------------
  Algeriano_Neo â€” Hybrid Final
  Single-file app: Full + Grid
  Storage: localStorage
------------------------------*/

/* Keys */
const LS_VIDEOS = 'alg_videos_hybrid_v1';
const LS_USERS = 'alg_users_hybrid_v1';
const LS_COMMENTS = 'alg_comments_hybrid_v1';
const LS_LIKES = 'alg_likes_hybrid_v1';
const LS_PAYMENTS = 'alg_payments_hybrid_v1';
const LS_SETTINGS = 'alg_settings_hybrid_v1';
const LS_CURRENT = 'alg_current_hybrid_v1';

/* Helpers */
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ return JSON.parse(localStorage.getItem(k) || 'null'); }
function ensure(k,init){ if(!localStorage.getItem(k)) save(k,init); return load(k); }
function uid(){ return Date.now()+Math.floor(Math.random()*999); }

/* Init default data */
function initData(){
  ensure(LS_SETTINGS, {siteName:'Algeriano_Neo', baridiNumber:'07XXXXXXXX', adminUser:'admin', adminPass:'admin123'});
  ensure(LS_USERS, [{id:'you', username:'you', display:'Ø£Ù†Øª', coins:0}]);
  ensure(LS_COMMENTS, []);
  ensure(LS_LIKES, {});
  ensure(LS_PAYMENTS, []);
  if(!localStorage.getItem(LS_VIDEOS)){
    save(LS_VIDEOS, [
      {id:1, user:'algeriano', title:'ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', src:'https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4', likes:120, views:230, created:Date.now()-300000},
      {id:2, user:'sara_dz', title:'Ø²Ù‡Ø±Ø©', src:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4', likes:88, views:140, created:Date.now()-200000},
      {id:3, user:'yassine', title:'Ù‚ØµÙŠØ±', src:'https://samplelib.com/lib/preview/mp4/sample-5s.mp4', likes:45, views:78, created:Date.now()-100000}
    ]);
  }
  ensure(LS_CURRENT, {username:'you'});
}
initData();

/* Elements */
const feedFull = document.getElementById('feedFull');
const feedGrid = document.getElementById('feedGrid');
const baridiDisplay = document.getElementById('baridiDisplay');

/* UI: update settings display */
function refreshUIstats(){
  const vids = ensure(LS_VIDEOS); const users = ensure(LS_USERS); const payments = ensure(LS_PAYMENTS);
  document.getElementById('statVideos').innerText = 'ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª: ' + vids.length;
  document.getElementById('statUsers').innerText = 'Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + users.length;
  document.getElementById('statPayments').innerText = 'Ø·Ù„Ø¨Ø§Øª Ø¯ÙØ¹: ' + payments.length;
  const set = ensure(LS_SETTINGS); baridiDisplay.innerText = set.baridiNumber || '(ÙØ§Ø±Øº)';
  // favorites preview (simple top liked)
  const favGrid = document.getElementById('favGrid'); favGrid.innerHTML='';
  vids.slice(0,3).forEach(v=>{ const d=document.createElement('div'); d.style.background='#071018'; d.style.borderRadius='8px'; d.style.padding='8px'; d.style.fontSize='12px'; d.innerText=v.title; favGrid.appendChild(d); });
}

/* Renderers */
function renderFull(order='latest', filter=''){
  feedFull.innerHTML=''; feedFull.scrollTop=0;
  let vids = ensure(LS_VIDEOS).slice();
  if(order==='latest') vids.sort((a,b)=>b.created - a.created);
  else vids.sort(()=>Math.random()-0.5);
  if(filter){ vids = vids.filter(v=> (v.title||'').includes(filter) || (v.user||'').includes(filter)); }
  vids.forEach(v=>{
    const sec = document.createElement('section'); sec.className='feed-card';
    sec.innerHTML = `
      <video class="feed-video" src="${v.src}" playsinline muted preload="metadata"></video>
      <div class="meta">
        <div class="user">@${v.user}</div>
        <div class="title">${v.title}</div>
      </div>
      <div class="side-controls">
        <div class="icon" data-id="${v.id}" onclick="toggleLike(event)">â¤ <span class="count" id="like-${v.id}">${v.likes||0}</span></div>
        <div class="icon" onclick="openComments(${v.id})">ğŸ’¬</div>
        <div class="icon" onclick="shareVideo('${encodeURIComponent(v.src)}')">ğŸ”—</div>
      </div>
    `;
    feedFull.appendChild(sec);
  });
  setTimeout(()=>attachObservers(),50);
}

function renderGrid(order='latest', filter=''){
  feedGrid.innerHTML=''; feedGrid.scrollTop=0;
  let vids = ensure(LS_VIDEOS).slice();
  if(order==='latest') vids.sort((a,b)=>b.created - a.created);
  else vids.sort(()=>Math.random()-0.5);
  if(filter){ vids = vids.filter(v=> (v.title||'').includes(filter) || (v.user||'').includes(filter)); }
  vids.forEach(v=>{
    const item = document.createElement('div'); item.className='grid-item';
    item.innerHTML = `<img class="grid-thumb" src="${videoPoster(v.src)}" onerror="this.src='https://via.placeholder.com/400x240.png?text=Video'"/>
      <div class="grid-title">${v.title}</div>
      <div class="grid-user">@${v.user}</div>`;
    item.addEventListener('click', ()=>{ openVideoFromGrid(v.id); });
    feedGrid.appendChild(item);
  });
}

/* utility to generate thumbnail placeholder: if remote mp4 can't poster, use placeholder */
function videoPoster(src){
  // if src is data URL or remote, use placeholder (browsers don't allow generating poster easily client-side)
  return 'https://via.placeholder.com/400x240.png?text=Algeriano_Neo';
}

/* Autoplay observer for full feed */
let io;
function attachObservers(){
  const vids = Array.from(document.querySelectorAll('.feed-video'));
  if(io) io.disconnect();
  io = new IntersectionObserver(entries=>{
    entries.forEach(en=>{
      const v = en.target;
      if(en.isIntersecting && en.intersectionRatio>0.6){ v.muted=false; v.play().catch(()=>{}); incrementView(v.src); }
      else v.pause();
    });
  }, {threshold:[0.6]});
  vids.forEach(v=> io.observe(v));
}

/* Views actions */
function openVideoFromGrid(id){
  const vids = ensure(LS_VIDEOS);
  const v = vids.find(x=>x.id===id);
  if(v){
    // move to top for full view
    const idx = vids.indexOf(v); vids.splice(idx,1); vids.unshift(v); save(LS_VIDEOS, vids);
    renderFull(); toggleToFull();
    // scroll top
    document.querySelector('.feed-full').scrollTo({top:0,behavior:'smooth'});
  }
}

/* Likes */
function toggleLike(e){
  const id = parseInt(e.currentTarget.dataset.id);
  const likes = ensure(LS_LIKES);
  const user = ensure(LS_CURRENT).username;
  const key = `${user}_${id}`;
  if(likes[key]){ delete likes[key]; updateLikeCount(id,-1); }
  else { likes[key]=true; updateLikeCount(id,+1); }
  save(LS_LIKES, likes); renderLikeUI(id);
}
function updateLikeCount(id,delta){
  const vids = ensure(LS_VIDEOS);
  const v = vids.find(x=>x.id===id);
  if(v){ v.likes = (v.likes||0) + delta; save(LS_VIDEOS, vids); const el = document.getElementById('like-'+id); if(el) el.innerText = v.likes; refreshUIstats(); }
}
function renderLikeUI(id){
  const likes = ensure(LS_LIKES); const user = ensure(LS_CURRENT).username; const key = `${user}_${id}`; const el = document.querySelector(`[data-id="${id}"]`); if(el) el.style.background = likes[key] ? 'linear-gradient(90deg,var(--primary),var(--accent))' : '';
}

/* Views: comments overlay */
function openComments(id){
  const comments = ensure(LS_COMMENTS).filter(c=>c.videoId===id);
  const html = `<h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
    <div style="max-height:40vh;overflow:auto;margin-top:8px">${comments.map(c=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>@${c.user}</strong><div class="small">${c.text}</div></div>`).join('') || '<div class="small">Ù„Ø§ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</div>'}</div>
    <div style="margin-top:8px" class="form-row"><input id="cText" class="input" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚"><button class="btn primary" onclick="postComment(${id})">Ù†Ø´Ø±</button></div>`;
  showOverlay(html);
}
function postComment(id){
  const txt = document.getElementById('cText').value.trim();
  if(!txt) return alert('Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚');
  const comments = ensure(LS_COMMENTS); const user = ensure(LS_CURRENT).username;
  comments.unshift({id:uid(), videoId:id, user:user, text:txt, created:Date.now()}); save(LS_COMMENTS, comments); closeOverlay(); alert('ØªÙ… Ø§Ù„Ù†Ø´Ø±'); refreshUIstats();
}

/* share */
function shareVideo(enc){
  const src = decodeURIComponent(enc);
  if(navigator.share) navigator.share({title:'Ø´ÙˆÙ Ù‡Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ', url:src}).catch(()=>{});
  else prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', src);
}

/* overlay helpers */
function showOverlay(html){
  const ov = document.getElementById('overlay'); const card = document.getElementById('overlayCard');
  card.innerHTML = html + '<div style="text-align:left;margin-top:10px"><button class="btn" onclick="closeOverlay()">Ø¥ØºÙ„Ø§Ù‚</button></div>';
  ov.style.display='flex'; ov.setAttribute('aria-hidden','false');
}
function closeOverlay(){ const ov=document.getElementById('overlay'); ov.style.display='none'; ov.setAttribute('aria-hidden','true'); document.getElementById('overlayCard').innerHTML=''; }

/* Upload flows (top and sidebar) */
document.getElementById('btnUpload').addEventListener('click', openUpload);
document.getElementById('sideUploadBtn').addEventListener('click', sideDoUpload);
document.getElementById('sideClear').addEventListener('click', ()=>{ document.getElementById('sideFile').value=''; document.getElementById('sideUrl').value=''; document.getElementById('sideTitle').value=''; });

function openUpload(){
  showOverlay(`<h3>Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h3>
    <div class="form-row"><input id="upFile" type="file" accept="video/*" class="input"></div>
    <div style="margin-top:8px"><input id="upUrl" placeholder="Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· mp4" class="input"></div>
    <div style="margin-top:8px"><input id="upTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" class="input"></div>
    <div style="margin-top:8px"><button class="btn primary" onclick="doUpload()">Ø±ÙØ¹</button></div>
    <div class="small" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø±ÙØ¹ Ù…Ù„ÙØ§Øª ÙƒØ¨ÙŠØ±Ø© Ø¹Ù„Ù‰ localStorage Ù…Ø­Ø¯ÙˆØ¯ØŒ Ø§Ø³ØªØ¹Ù…Ù„ Ø±ÙˆØ§Ø¨Ø· Ø¥Ù† Ø£Ù…ÙƒÙ†</div>`);
}
function doUpload(){
  const f = document.getElementById('upFile')?.files?.[0]; const url = document.getElementById('upUrl')?.value.trim(); const title = document.getElementById('upTitle')?.value.trim()||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  if(f){
    const r=new FileReader(); r.onload=function(e){ addVideo({src:e.target.result,title}); closeOverlay(); alert('ØªÙ… Ø§Ù„Ø±ÙØ¹ (Ù…Ø­Ù„ÙŠ)'); }; r.readAsDataURL(f); return;
  }
  if(url){ addVideo({src:url,title}); closeOverlay(); alert('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©'); return; }
  alert('Ø§Ø®ØªØ§Ø± Ù…Ù„Ù Ø£Ùˆ Ø±Ø§Ø¨Ø·');
}
function sideDoUpload(){
  const f = document.getElementById('sideFile')?.files?.[0]; const url = document.getElementById('sideUrl')?.value.trim(); const title = document.getElementById('sideTitle')?.value.trim()||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  if(f){
    const r=new FileReader(); r.onload=function(e){ addVideo({src:e.target.result,title}); alert('ØªÙ… Ø§Ù„Ø±ÙØ¹'); }; r.readAsDataURL(f); return;
  }
  if(url){ addVideo({src:url,title}); alert('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©'); return; }
  alert('Ø§Ø®ØªØ§Ø± Ù…Ù„Ù Ø£Ùˆ Ø±Ø§Ø¨Ø·');
}
function addVideo({src,title}){
  const vids = ensure(LS_VIDEOS); const id=uid(); vids.unshift({id:id,user:ensure(LS_CURRENT).username||'you',title:title,src:src,likes:0,views:0,created:Date.now()}); save(LS_VIDEOS,vids); renderFull(); renderGrid(); refreshUIstats();
}

/* Profile */
document.getElementById('btnProfile').addEventListener('click', openProfile);
function openProfile(){
  const cur = ensure(LS_CURRENT);
  showOverlay(`<h3>Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ â€” @${cur.username}</h3><div class="small">Coins: ${cur.coins||0}</div><div style="margin-top:8px"><button class="btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button></div><h4 style="margin-top:12px">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙŠ</h4><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">${ensure(LS_VIDEOS).filter(v=>v.user===cur.username).map(v=>`<div style="background:#071018;border-radius:8px;padding:8px;text-align:center;cursor:pointer" onclick="openFromThumb('${encodeURIComponent(v.src)}')">${v.title}</div>`).join('')||'<div class="small">Ù„Ø§ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</div>'}</div>`);
}
function openFromThumb(enc){ const src=decodeURIComponent(enc); const vids=ensure(LS_VIDEOS); const v=vids.find(x=>x.src===src); if(v){ const idx=vids.indexOf(v); vids.splice(idx,1); vids.unshift(v); save(LS_VIDEOS,vids); renderFull(); renderGrid(); closeOverlay(); document.querySelector('.feed-full')?.scrollTo({top:0,behavior:'smooth'}); } }
function logout(){ if(confirm('ØªØ±ÙŠØ¯ ØªØ®Ø±Ø¬ØŸ')){ save(LS_CURRENT,{username:'guest'}); closeOverlay(); alert('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬'); } }

/* Search & Random */
document.getElementById('search').addEventListener('input',(e)=>{ const v=e.target.value.trim(); if(v.length>0) { renderFull('latest',v); renderGrid('latest',v);} else { renderFull(); renderGrid(); } });
document.getElementById('btnRandom').addEventListener('click', ()=>{ renderFull('random',''); renderGrid('random',''); document.querySelector('.feed-full').scrollTo({top:0,behavior:'smooth'}); });

/* Toggle view */
const btnToggle = document.getElementById('btnToggleView');
let currentView = 'full';
btnToggle.addEventListener('click', ()=>{ if(currentView==='full') toggleToGrid(); else toggleToFull(); });
function toggleToGrid(){ currentView='grid'; document.getElementById('feedFull').style.display='none'; document.getElementById('feedGrid').style.display='grid'; btnToggle.innerText='Grid âœ“'; }
function toggleToFull(){ currentView='full'; document.getElementById('feedFull').style.display='block'; document.getElementById('feedGrid').style.display='none'; btnToggle.innerText='Full âœ“'; }

/* Admin quick (double-click header) */
document.querySelector('.header').addEventListener('dblclick', ()=>{
  const settings = ensure(LS_SETTINGS);
  const u = prompt('Ø§Ø³Ù… Ø§Ù„Ø§Ø¯Ù…Ù†','admin'); const p = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±','admin123');
  if(u===settings.adminUser && p===settings.adminPass){
    showAdminPanel();
  } else alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
});

function showAdminPanel(){
  const vids = ensure(LS_VIDEOS); const users = ensure(LS_USERS); const payments = ensure(LS_PAYMENTS); const settings = ensure(LS_SETTINGS);
  const html = `<h3>Ù„ÙˆØ­Ø© Admin â€” Algeriano_Neo</h3>
    <div class="small">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª: ${vids.length} â€” Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${users.length} â€” Ø·Ù„Ø¨Ø§Øª: ${payments.length}</div>
    <div style="margin-top:8px">
      <button class="btn" onclick="openManageVideos()">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
      <button class="btn" onclick="openManageUsers()">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
      <button class="btn" onclick="showPayments()">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</button>
      <button class="btn" onclick="openSettings()">Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
    <div style="margin-top:8px"><button class="btn ghost" onclick="closeOverlay()">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
  showOverlay(html);
}

/* Manage videos/users */
function openManageVideos(){
  const vids = ensure(LS_VIDEOS);
  const html = `<h3>Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3><div style="max-height:50vh;overflow:auto">${vids.map(v=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${v.title}</strong> â€” @${v.user}<div style="margin-top:6px"><button class="btn" onclick="adminDeleteVideo(${v.id})">Ø­Ø°Ù</button></div></div>`).join('')}</div><div style="margin-top:8px"><button class="btn ghost" onclick="closeOverlay()">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
  showOverlay(html);
}
function adminDeleteVideo(id){ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ')) return; let vids = ensure(LS_VIDEOS); vids = vids.filter(v=>v.id!==id); save(LS_VIDEOS,vids); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); renderFull(); renderGrid(); closeOverlay(); refreshUIstats(); }
function openManageUsers(){ const users = ensure(LS_USERS); const html = `<h3>Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3><div style="max-height:50vh;overflow:auto">${users.map(u=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)">@${u.username} â€” Coins: ${u.coins||0}<div style="margin-top:6px"><button class="btn" onclick="adminAdjustCoins('${u.username}')">ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø§Ø·</button></div></div>`).join('')}</div><div style="margin-top:8px"><button class="btn ghost" onclick="closeOverlay()">Ø¥ØºÙ„Ø§Ù‚</button></div>`; showOverlay(html); }
function adminAdjustCoins(username){ const amount = parseInt(prompt('ÙƒÙ… ØªØ±ÙŠØ¯ ØªØ¶ÙŠÙ/ØªÙ†Ù‚Øµ (Ù…Ø«Ø§Ù„ +100 Ø£Ùˆ -50) Ù„Ù„Ù€ '+username,'+100')); if(isNaN(amount)) return alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); const users = ensure(LS_USERS); const u = users.find(x=>x.username===username); if(!u) return; u.coins = (u.coins||0) + amount; save(LS_USERS,users); alert('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); openManageUsers(); }

/* Payments (manual BaridiMob) */
function openPaymentFlow(){
  showOverlay(`<h3>Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ â€” BaridiMob</h3>
    <div class="small">Ø§Ù†Ø³Ø® Ø±Ù‚Ù… BaridiMob Ùˆ Ù‚Ù… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø«Ù… Ø§Ø±ÙÙ‚ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„</div>
    <div style="margin-top:8px"><input id="payAmount" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø¬)"></div>
    <div style="margin-top:8px"><input id="payNote" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
    <div style="margin-top:8px"><input id="payReceipt" type="file" accept="image/*"></div>
    <div style="margin-top:8px"><button class="btn primary" onclick="doPayment()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button></div>`);
}
document.getElementById('btnPay').addEventListener('click', openPaymentFlow);
function doPayment(){
  const amount = parseInt(document.getElementById('payAmount')?.value||0); const note = document.getElementById('payNote')?.value||''; const file = document.getElementById('payReceipt')?.files?.[0];
  if(!amount || !file) return alert('Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ÙˆØ±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„');
  const r=new FileReader(); r.onload=function(e){ const payments = ensure(LS_PAYMENTS); const user = ensure(LS_CURRENT).username; const id=uid(); payments.unshift({id:id,user:user,amount:amount,note:note,receipt:e.target.result,status:'pending',created:Date.now()}); save(LS_PAYMENTS,payments); alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨'); closeOverlay(); refreshUIstats(); }; r.readAsDataURL(file);
}
function showPayments(){
  const payments = ensure(LS_PAYMENTS); const settings = ensure(LS_SETTINGS);
  const html = `<h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ (BaridiMob)</h3><div class="small">BaridiMob: ${settings.baridiNumber || '(ÙØ§Ø±Øº)'}</div><div style="margin-top:8px">${payments.length?payments.map(p=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>@${p.user}</strong> â€” ${p.amount} Ø¯Ø¬ â€” Ø§Ù„Ø­Ø§Ù„Ø©: <em>${p.status}</em><div style="margin-top:6px"><img src="${p.receipt}" style="max-width:160px;border-radius:6px"></div><div style="margin-top:6px"><button class="btn" onclick="confirmPayment(${p.id})">Ù‚Ø¨ÙˆÙ„</button> <button class="btn ghost" onclick="rejectPayment(${p.id})">Ø±ÙØ¶</button></div></div>`).join(''):'<div class="small">Ù…Ø§ÙƒØ§Ù† Ø­ØªÙ‰ Ø·Ù„Ø¨</div>'}</div><div style="margin-top:8px"><button class="btn ghost" onclick="closeOverlay()">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
  showOverlay(html);
}
function confirmPayment(id){
  const payments = ensure(LS_PAYMENTS); const idx = payments.findIndex(x=>x.id===id); if(idx===-1) return; payments[idx].status='confirmed'; save(LS_PAYMENTS,payments);
  // grant coins: 1 coin = 10 DZD
  const users = ensure(LS_USERS); let u = users.find(x=>x.username===payments[idx].user); if(!u){ u={id:payments[idx].user,username:payments[idx].user,display:payments[idx].user,coins:0}; users.push(u); }
  const coins = Math.round(payments[idx].amount/10); u.coins = (u.coins||0) + coins; save(LS_USERS,users);
  alert('ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ â€” Ø±ØµÙŠØ¯ ØªÙ…Øª Ø§Ø¶Ø§ÙØªÙ‡: ' + coins + ' coins'); refreshUIstats(); closeOverlay();
}
function rejectPayment(id){ let payments = ensure(LS_PAYMENTS); const idx=payments.findIndex(x=>x.id===id); if(idx===-1) return; payments[idx].status='rejected'; save(LS_PAYMENTS,payments); alert('ØªÙ… Ø§Ù„Ø±ÙØ¶'); refreshUIstats(); }

/* Admin helpers: settings */
function openSettings(){
  const settings = ensure(LS_SETTINGS);
  showOverlay(`<h3>Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <div class="form-row"><label class="small">BaridiMob</label><input id="setBaridi" class="input" value="${settings.baridiNumber||''}"></div>
    <div style="margin-top:8px"><button class="btn" onclick="saveSettings()">Ø­ÙØ¸</button></div>`);
}
function saveSettings(){ const v=document.getElementById('setBaridi').value.trim(); const s=ensure(LS_SETTINGS); s.baridiNumber=v; save(LS_SETTINGS,s); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); closeOverlay(); refreshUIstats(); }

/* admin manage entry points */
function openManageUsers(){ showAdminPanel(); }
function openManageVideos(){ showAdminPanel(); }

/* export/import */
function exportData(){ const data={videos:ensure(LS_VIDEOS),users:ensure(LS_USERS),comments:ensure(LS_COMMENTS),likes:ensure(LS_LIKES),payments:ensure(LS_PAYMENTS)}; const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='algeriano_export.json'; a.click(); }

/* views glue */
function incrementView(src){
  const vids = ensure(LS_VIDEOS);
  const v = vids.find(x=>x.src===src); if(v){ v.views = (v.views||0)+1; save(LS_VIDEOS,vids); }
}

/* open video from grid */
function openFromThumb(enc){ const src=decodeURIComponent(enc); const vids=ensure(LS_VIDEOS); const v=vids.find(x=>x.src===src); if(v){ const idx=vids.indexOf(v); vids.splice(idx,1); vids.unshift(v); save(LS_VIDEOS,vids); renderFull(); toggleToFull(); closeOverlay(); document.getElementById('feedFull').scrollTo({top:0,behavior:'smooth'}); } }

/* init render */
renderFull(); renderGrid(); refreshUIstats(); toggleToFull();

/* initial controls */
document.getElementById('btnAdminMini').addEventListener('click', ()=>{ const settings=ensure(LS_SETTINGS); const u=prompt('admin user','admin'); const p=prompt('admin pass','admin123'); if(u===settings.adminUser && p===settings.adminPass) showAdminPanel(); else alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©'); });
document.getElementById('btnProfile').addEventListener('click', openProfile);

/* small keyboard: press G to go Grid, F to Full */
document.addEventListener('keydown',(e)=>{ if(e.key==='g' || e.key==='G') toggleToGrid(); if(e.key==='f' || e.key==='F') toggleToFull(); });

/* helper for opening payments from header if user clicks btnPay */
function openPaymentFromHeader(){ openPaymentFlow(); }

/* Safe: close overlays on Escape */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeOverlay(); });

</script>
</body>
</html>
